const http = require('http');
const { parse } = require('querystring');
const fs = require('fs').promises;

const requestListener = function (req, res) {
  if (req.method === 'POST') {
    collectRequestData(req, result => {
      console.log(result);
      res.end(`Parsed data belonging to ${result.fname}`);
    });
  }
  else {
    res.end(`
            <!doctype html>
            <html>
            <head>
                <title>Mandelbrot</title>
                <meta charset="utf-8" />
                <link rel="stylesheet" href="index.css">  
            </head>

            <body>
                <form action="/" method="post">
                    <input type="text" name="fname" /><br />
                    <input type="number" name="age" /><br />
                    <input type="file" name="photo" /><br />
                    <button>Save</button>
                </form>
            </body>
            </html>
        `);
  }
};

const server = http.createServer(requestListener);
server.listen(8000);

function collectRequestData(request, callback) {
  const FORM_URLENCODED = 'application/x-www-form-urlencoded';
  if (request.headers['content-type'] === FORM_URLENCODED) {
    let body = '';
    request.on('data', chunk => {
      body += chunk.toString();
    });
    request.on('end', () => {
      callback(parse(body));
    });
  }
  else {
    callback(null);
  }
}